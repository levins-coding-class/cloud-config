#cloud-config
# =============================================================================
# Coding Class - Linux Desktop für Kinder
# =============================================================================
#
# VERWENDUNG:
#   1. Hetzner Cloud Console → Server erstellen
#   2. Server-Name: coding-class-<kindname> (z.B. "coding-class-friedrich")
#   3. Ubuntu 24.04 auswählen
#   4. Bei "Cloud config" dieses YAML einfügen (KEINE Anpassung nötig!)
#   5. Server erstellen & warten (~10 Minuten)
#
# ZUGANG:
#   Kind (RDP):  <ip>:3389, User: <kindname>, Passwort: codingclass
#   Admin (VNC): <ip>:5900, Passwort: levin
#   Admin (SSH): ssh levin@<ip>
#
# =============================================================================

# --- Admin-User ---
users:
  - name: levin
    groups: sudo, adm
    shell: /bin/bash
    sudo: ALL=(ALL) NOPASSWD:ALL
    lock_passwd: false
    ssh_authorized_keys:
      - ecdsa-sha2-nistp256 AAAAE2VjZHNhLXNoYTItbmlzdHAyNTYAAAAIbmlzdHAyNTYAAABBBINCAQL3itd2FpbGK6xAka3mU/PzfZeKW8s6wRCmL5ONkUjffZC1BWG/iNi3XU4WX//piOemqmRzgYIjJW0gItY=
      - ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABgQCgXjznNCRu7IYiAq36fXravwWwwJ5xjCKgQo6pso48UMh2UJnjV2JjmFswUGKOD/zowUXveCwzRdh8jEvRBXoBJndbhaMC2Imu/5iWM2699VnkFEV3FbnKfHTIzJU+hiWr84pZobiHkc0jHO/HEzlGVzvVyegioxmz56a6BjalCeGhR/IHsObLQpVjWqetw+XSMzAj0dqTc+xg+bIMrnoSUDkroDrOarhdnsFPpu4NYPEiYqevbYEub0YNtEC9Zq/0gYBE73taBio4Fskb/NxQGzCjr0MNv63svXiUsDOtXdxdPRUmnsIvb0QXTKDct1zbw3y4qQdQUpVci1+z8uAC3oxBdA1JL4++KitYJfASzxnNWfVDl1hunfT72sbNxfHuZ1xMHoFkouFaeCwj8L2w4Wn5uxpq6sN+Qz/rOnzi+Tge8/sLY0NbU8+K7pW2EvcSdIWMzhbr8CWURCAZlqipJfPDJ+NZHOSdcQabJYLaOkuSDsxG0CWa1EuiplKb8TM=

chpasswd:
  expire: false
  list:
    - levin:levin

# --- Pakete ---
package_update: true
package_upgrade: true

packages:
  - ubuntu-desktop-minimal
  - xrdp
  - x11vnc
  - git
  - build-essential
  - python3
  - python3-pip
  - firefox
  - gedit
  - htop
  - curl
  - wget
  - net-tools

snap:
  commands:
    - snap install code --classic

# --- Konfigurationsdateien ---
write_files:
  - path: /etc/systemd/system/x11vnc.service
    content: |
      [Unit]
      Description=x11vnc Session Sharing
      After=display-manager.service
      Requires=display-manager.service

      [Service]
      Type=simple
      ExecStartPre=/bin/sleep 10
      ExecStart=/usr/bin/x11vnc -display :0 -auth guess -forever -loop -noxdamage -repeat -rfbauth /etc/x11vnc/passwd -rfbport 5900 -shared -capslock -nomodtweak
      Restart=on-failure
      RestartSec=5

      [Install]
      WantedBy=graphical.target

  - path: /etc/xrdp/xrdp.ini
    content: |
      [Globals]
      ini_version=1
      fork=true
      port=3389
      tcp_nodelay=true
      tcp_keepalive=true
      security_layer=negotiate
      crypt_level=high
      certificate=
      key_file=
      ssl_protocols=TLSv1.2, TLSv1.3
      autorun=Vnc-any
      allow_channels=true
      allow_multimon=true
      bitmap_cache=true
      bitmap_compression=true
      bulk_compression=true
      max_bpp=32
      new_cursors=true
      use_fastpath=both

      [Logging]
      LogFile=xrdp.log
      LogLevel=INFO
      EnableSyslog=true
      SyslogLevel=INFO

      [Channels]
      rdpdr=true
      rdpsnd=true
      drdynvc=true
      cliprdr=true
      rail=true
      xrdpvr=true
      tcutils=true

      [Vnc-any]
      name=VNC Session
      lib=libvnc.so
      ip=127.0.0.1
      port=5900
      username=na
      password=ask

  - path: /etc/polkit-1/rules.d/45-allow-colord.rules
    content: |
      polkit.addRule(function(action, subject) {
          if ((action.id == "org.freedesktop.color-manager.create-device" ||
               action.id == "org.freedesktop.color-manager.create-profile" ||
               action.id == "org.freedesktop.color-manager.delete-device" ||
               action.id == "org.freedesktop.color-manager.delete-profile" ||
               action.id == "org.freedesktop.color-manager.modify-device" ||
               action.id == "org.freedesktop.color-manager.modify-profile") &&
              subject.isInGroup("users")) {
              return polkit.Result.YES;
          }
      });

  - path: /etc/systemd/system/coding-class-setup.service
    content: |
      [Unit]
      Description=Coding Class Desktop Setup
      After=snapd.seeded.service graphical.target
      Wants=snapd.seeded.service

      [Service]
      Type=oneshot
      ExecStart=/usr/local/bin/coding-class-setup.sh
      RemainAfterExit=yes

      [Install]
      WantedBy=multi-user.target

  - path: /usr/local/bin/coding-class-setup.sh
    permissions: '0755'
    content: |
      #!/bin/bash
      source /etc/coding-class.conf

      echo "=== Coding Class Setup startet ==="

      # Warten bis Snap fertig ist
      for i in {1..30}; do
          if snap list code &>/dev/null; then
              echo "VS Code Snap gefunden"
              break
          fi
          echo "Warte auf Snap... ($i/30)"
          sleep 10
      done

      # Desktop-Verknüpfungen erstellen
      DESKTOP_DIR="/home/$KINDNAME/Desktop"
      mkdir -p "$DESKTOP_DIR"

      # VS Code
      if [ -f /var/lib/snapd/desktop/applications/code_code.desktop ]; then
          cp /var/lib/snapd/desktop/applications/code_code.desktop "$DESKTOP_DIR/"
          echo "VS Code Desktop-Link erstellt"
      fi

      # Firefox
      if [ -f /usr/share/applications/firefox.desktop ]; then
          cp /usr/share/applications/firefox.desktop "$DESKTOP_DIR/"
          echo "Firefox Desktop-Link erstellt"
      fi

      # Ausführbar machen und Ownership setzen
      chmod +x "$DESKTOP_DIR"/*.desktop 2>/dev/null || true
      chown -R $KINDNAME:$KINDNAME "$DESKTOP_DIR"

      # Service deaktivieren (einmalige Ausführung)
      systemctl disable coding-class-setup.service

      echo "=== Coding Class Setup abgeschlossen ==="

# --- Befehle ---
runcmd:
  # Hostname von Hetzner holen (falls verfügbar)
  - |
    HETZNER_HOSTNAME=$(curl -sf --connect-timeout 2 http://169.254.169.254/hetzner/v1/metadata/hostname || echo "")
    if [ -n "$HETZNER_HOSTNAME" ]; then
      hostnamectl set-hostname "$HETZNER_HOSTNAME"
      echo "Hostname von Hetzner: $HETZNER_HOSTNAME"
    fi

  # Kind-User aus Hostname erstellen
  - |
    KINDNAME=$(hostname | sed 's/^coding-class-//')
    echo "=== Erstelle User: $KINDNAME ==="
    useradd -m -s /bin/bash -G users "$KINDNAME"
    echo "$KINDNAME:codingclass" | chpasswd
    mkdir -p /home/$KINDNAME/Desktop /home/$KINDNAME/Projekte
    chown -R $KINDNAME:$KINDNAME /home/$KINDNAME
    echo "KINDNAME=$KINDNAME" > /etc/coding-class.conf

  # GDM3 konfigurieren
  - |
    source /etc/coding-class.conf
    cat > /etc/gdm3/custom.conf << GDMEOF
    [daemon]
    WaylandEnable=false
    AutomaticLoginEnable=true
    AutomaticLogin=$KINDNAME

    [security]

    [xdmcp]

    [chooser]

    [debug]
    GDMEOF

  # VNC Passwort setzen
  - mkdir -p /etc/x11vnc
  - x11vnc -storepasswd levin /etc/x11vnc/passwd

  # Services aktivieren
  - systemctl daemon-reload
  - systemctl enable x11vnc.service
  - adduser xrdp ssl-cert 2>/dev/null || true
  - systemctl enable xrdp
  - systemctl enable coding-class-setup.service

  # Firewall
  - ufw allow 22/tcp
  - ufw allow 3389/tcp
  - ufw allow 5900/tcp
  - ufw --force enable

  # Abschluss-Log
  - |
    source /etc/coding-class.conf
    echo "$(date): Cloud-init done, User: $KINDNAME" > /var/log/coding-class-complete.log

  # Reboot
  - reboot

final_message: "Coding Class Desktop fertig nach $UPTIME Sekunden. Reboot..."
