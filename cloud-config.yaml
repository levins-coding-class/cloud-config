#cloud-config
# =============================================================================
# Coding Class - Linux Desktop für Kinder
# =============================================================================
#
# VERWENDUNG:
#   1. Hetzner Cloud Console → Server erstellen
#   2. Server-Name: <kindname>-desktop (z.B. "friedrich-desktop")
#   3. Ubuntu 24.04 auswählen
#   4. Bei "Cloud config" dieses YAML einfügen (KEINE Anpassung nötig!)
#   5. Server erstellen & warten (~10 Minuten)
#
# ZUGANG:
#   Kind (RDP):  <ip>:3389, User: <kindname>, Passwort: codingclass
#   Admin (VNC): <ip>:5900, Passwort: levin
#   Admin (SSH): ssh levin@<ip>
#
# =============================================================================

# --- Admin-User (immer gleich) ---
users:
  - name: levin
    groups: sudo, adm
    shell: /bin/bash
    sudo: ALL=(ALL) NOPASSWD:ALL
    lock_passwd: false
    ssh_authorized_keys:
      - ecdsa-sha2-nistp256 AAAAE2VjZHNhLXNoYTItbmlzdHAyNTYAAAAIbmlzdHAyNTYAAABBBINCAQL3itd2FpbGK6xAka3mU/PzfZeKW8s6wRCmL5ONkUjffZC1BWG/iNi3XU4WX//piOemqmRzgYIjJW0gItY=
      - ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABgQCgXjznNCRu7IYiAq36fXravwWwwJ5xjCKgQo6pso48UMh2UJnjV2JjmFswUGKOD/zowUXveCwzRdh8jEvRBXoBJndbhaMC2Imu/5iWM2699VnkFEV3FbnKfHTIzJU+hiWr84pZobiHkc0jHO/HEzlGVzvVyegioxmz56a6BjalCeGhR/IHsObLQpVjWqetw+XSMzAj0dqTc+xg+bIMrnoSUDkroDrOarhdnsFPpu4NYPEiYqevbYEub0YNtEC9Zq/0gYBE73taBio4Fskb/NxQGzCjr0MNv63svXiUsDOtXdxdPRUmnsIvb0QXTKDct1zbw3y4qQdQUpVci1+z8uAC3oxBdA1JL4++KitYJfASzxnNWfVDl1hunfT72sbNxfHuZ1xMHoFkouFaeCwj8L2w4Wn5uxpq6sN+Qz/rOnzi+Tge8/sLY0NbU8+K7pW2EvcSdIWMzhbr8CWURCAZlqipJfPDJ+NZHOSdcQabJYLaOkuSDsxG0CWa1EuiplKb8TM=

chpasswd:
  expire: false
  list:
    - levin:levin

# --- Pakete ---
package_update: true
package_upgrade: true

packages:
  - ubuntu-desktop-minimal
  - xrdp
  - x11vnc
  - git
  - build-essential
  - python3
  - python3-pip
  - firefox
  - gedit
  - htop
  - curl
  - wget
  - net-tools

snap:
  commands:
    - snap install code --classic

# --- Konfiguration ---
runcmd:
  # ---------------------------------------------
  # Kind-User aus Hostname ableiten
  # Server "friedrich-desktop" → User "friedrich"
  # ---------------------------------------------
  - |
    KINDNAME=$(hostname | cut -d'-' -f1)
    echo "Erstelle User: $KINDNAME"
    
    # Kind-User anlegen
    useradd -m -s /bin/bash -G users "$KINDNAME"
    echo "$KINDNAME:codingclass" | chpasswd
    
    # Desktop-Verzeichnis vorbereiten
    mkdir -p /home/$KINDNAME/Desktop
    mkdir -p /home/$KINDNAME/Projekte
    chown -R $KINDNAME:$KINDNAME /home/$KINDNAME
    
    # Variable für spätere Scripts speichern
    echo "KINDNAME=$KINDNAME" > /etc/coding-class.conf

  # ---------------------------------------------
  # X11 erzwingen (statt Wayland)
  # ---------------------------------------------
  - |
    sed -i 's/#WaylandEnable=false/WaylandEnable=false/' /etc/gdm3/custom.conf

  # ---------------------------------------------
  # Auto-Login für Kind konfigurieren
  # ---------------------------------------------
  - |
    source /etc/coding-class.conf
    cat >> /etc/gdm3/custom.conf << EOF
    
    [daemon]
    AutomaticLoginEnable=true
    AutomaticLogin=$KINDNAME
    EOF

  # ---------------------------------------------
  # x11vnc für Session-Sharing einrichten
  # ---------------------------------------------
  - |
    # VNC Passwort setzen
    mkdir -p /etc/x11vnc
    x11vnc -storepasswd levin /etc/x11vnc/passwd
    
    # Systemd Service für x11vnc
    cat > /etc/systemd/system/x11vnc.service << 'EOF'
    [Unit]
    Description=x11vnc Session Sharing
    After=display-manager.service
    Requires=display-manager.service
    
    [Service]
    Type=simple
    ExecStartPre=/bin/sleep 5
    ExecStart=/usr/bin/x11vnc -display :0 -auth guess -forever -loop -noxdamage -repeat -rfbauth /etc/x11vnc/passwd -rfbport 5900 -shared -capslock -nomodtweak
    Restart=on-failure
    RestartSec=3
    
    [Install]
    WantedBy=graphical.target
    EOF
    
    systemctl daemon-reload
    systemctl enable x11vnc.service

  # ---------------------------------------------
  # xrdp konfigurieren (verbindet zu VNC Session)
  # ---------------------------------------------
  - |
    # xrdp soll VNC-Session verbinden, nicht neue X-Session starten
    cat > /etc/xrdp/xrdp.ini << 'EOF'
    [Globals]
    ini_version=1
    fork=true
    port=3389
    tcp_nodelay=true
    tcp_keepalive=true
    security_layer=negotiate
    crypt_level=high
    certificate=
    key_file=
    ssl_protocols=TLSv1.2, TLSv1.3
    autorun=Vnc-any
    allow_channels=true
    allow_multimon=true
    bitmap_cache=true
    bitmap_compression=true
    bulk_compression=true
    max_bpp=32
    new_cursors=true
    use_fastpath=both
    
    [Logging]
    LogFile=xrdp.log
    LogLevel=INFO
    EnableSyslog=true
    SyslogLevel=INFO
    
    [Channels]
    rdpdr=true
    rdpsnd=true
    drdynvc=true
    cliprdr=true
    rail=true
    xrdpvr=true
    tcutils=true
    
    [Vnc-any]
    name=VNC Session
    lib=libvnc.so
    ip=127.0.0.1
    port=5900
    username=na
    password=ask
    EOF
    
    # SSL-Cert Zugriff
    adduser xrdp ssl-cert
    
    systemctl enable xrdp
    systemctl restart xrdp

  # ---------------------------------------------
  # Polkit für Farb-Management (xrdp braucht das)
  # ---------------------------------------------
  - |
    cat > /etc/polkit-1/localauthority/50-local.d/45-allow-colord.pkla << 'EOF'
    [Allow Colord all Users]
    Identity=unix-user:*
    Action=org.freedesktop.color-manager.create-device;org.freedesktop.color-manager.create-profile;org.freedesktop.color-manager.delete-device;org.freedesktop.color-manager.delete-profile;org.freedesktop.color-manager.modify-device;org.freedesktop.color-manager.modify-profile
    ResultAny=no
    ResultInactive=no
    ResultActive=yes
    EOF

  # ---------------------------------------------
  # Firewall
  # ---------------------------------------------
  - ufw allow 22/tcp
  - ufw allow 3389/tcp
  - ufw allow 5900/tcp
  - ufw --force enable

  # ---------------------------------------------
  # Desktop-Verknüpfungen nach Reboot setzen
  # (Snap-Apps sind erst nach Reboot verfügbar)
  # ---------------------------------------------
  - |
    cat > /etc/rc.local << 'RCEOF'
    #!/bin/bash
    source /etc/coding-class.conf
    sleep 30
    cp /var/lib/snapd/desktop/applications/code_code.desktop /home/$KINDNAME/Desktop/ 2>/dev/null || true
    cp /usr/share/applications/firefox.desktop /home/$KINDNAME/Desktop/ 2>/dev/null || true
    chmod +x /home/$KINDNAME/Desktop/*.desktop 2>/dev/null || true
    chown -R $KINDNAME:$KINDNAME /home/$KINDNAME/Desktop
    # Einmalig ausführen
    rm /etc/rc.local
    exit 0
    RCEOF
    chmod +x /etc/rc.local

  # ---------------------------------------------
  # Reboot
  # ---------------------------------------------
  - reboot

final_message: |
  =============================================
  Coding Class Desktop bereit!
  =============================================
  Cloud-init abgeschlossen nach $UPTIME Sekunden.
  Server startet jetzt neu...
  =============================================
