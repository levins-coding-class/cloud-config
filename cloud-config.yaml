#cloud-config
# =============================================================================
# Coding Class - Linux Desktop für Kinder
# =============================================================================
#
# VERWENDUNG:
#   1. Hetzner Cloud Console → Server erstellen
#   2. Server-Name: <kindname>-desktop (z.B. "friedrich-desktop")
#   3. Ubuntu 24.04 auswählen
#   4. Bei "Cloud config" dieses YAML einfügen (KEINE Anpassung nötig!)
#   5. Server erstellen & warten (~10 Minuten)
#
# ZUGANG:
#   Kind (RDP):  <ip>:3389, User: <kindname>, Passwort: codingclass
#   Admin (VNC): <ip>:5900, Passwort: levin
#   Admin (SSH): ssh levin@<ip>
#
# GETESTET MIT:
#   - Hetzner Cloud (Ubuntu 24.04)
#   - Multipass (lokal)
#
# =============================================================================

# --- Hostname von Hetzner übernehmen (falls verfügbar) ---
hostname: ${DS:NONE}
prefer_fqdn_over_hostname: false

# --- Admin-User (immer gleich) ---
users:
  - name: levin
    groups: sudo, adm
    shell: /bin/bash
    sudo: ALL=(ALL) NOPASSWD:ALL
    lock_passwd: false
    ssh_authorized_keys:
      - ecdsa-sha2-nistp256 AAAAE2VjZHNhLXNoYTItbmlzdHAyNTYAAAAIbmlzdHAyNTYAAABBBINCAQL3itd2FpbGK6xAka3mU/PzfZeKW8s6wRCmL5ONkUjffZC1BWG/iNi3XU4WX//piOemqmRzgYIjJW0gItY=
      - ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABgQCgXjznNCRu7IYiAq36fXravwWwwJ5xjCKgQo6pso48UMh2UJnjV2JjmFswUGKOD/zowUXveCwzRdh8jEvRBXoBJndbhaMC2Imu/5iWM2699VnkFEV3FbnKfHTIzJU+hiWr84pZobiHkc0jHO/HEzlGVzvVyegioxmz56a6BjalCeGhR/IHsObLQpVjWqetw+XSMzAj0dqTc+xg+bIMrnoSUDkroDrOarhdnsFPpu4NYPEiYqevbYEub0YNtEC9Zq/0gYBE73taBio4Fskb/NxQGzCjr0MNv63svXiUsDOtXdxdPRUmnsIvb0QXTKDct1zbw3y4qQdQUpVci1+z8uAC3oxBdA1JL4++KitYJfASzxnNWfVDl1hunfT72sbNxfHuZ1xMHoFkouFaeCwj8L2w4Wn5uxpq6sN+Qz/rOnzi+Tge8/sLY0NbU8+K7pW2EvcSdIWMzhbr8CWURCAZlqipJfPDJ+NZHOSdcQabJYLaOkuSDsxG0CWa1EuiplKb8TM=

chpasswd:
  expire: false
  list:
    - levin:levin

# --- Pakete ---
package_update: true
package_upgrade: true

packages:
  - ubuntu-desktop-minimal
  - xrdp
  - x11vnc
  - git
  - build-essential
  - python3
  - python3-pip
  - firefox
  - gedit
  - htop
  - curl
  - wget
  - net-tools

snap:
  commands:
    - snap install code --classic

# --- Konfiguration ---
runcmd:
  # ---------------------------------------------
  # Hostname setzen (Hetzner oder Multipass)
  # ---------------------------------------------
  - |
    # Versuche Hetzner Metadata, sonst behalte aktuellen Hostname
    HETZNER_HOSTNAME=$(curl -sf --connect-timeout 2 http://169.254.169.254/hetzner/v1/metadata/hostname || echo "")
    if [ -n "$HETZNER_HOSTNAME" ]; then
      hostnamectl set-hostname "$HETZNER_HOSTNAME"
      echo "Hostname von Hetzner gesetzt: $HETZNER_HOSTNAME"
    else
      echo "Kein Hetzner Metadata, behalte Hostname: $(hostname)"
    fi

  # ---------------------------------------------
  # Kind-User aus Hostname ableiten
  # Server "friedrich-desktop" → User "friedrich"
  # ---------------------------------------------
  - |
    KINDNAME=$(hostname | cut -d'-' -f1)
    echo "=== Erstelle User: $KINDNAME ==="

    # Kind-User anlegen
    useradd -m -s /bin/bash -G users "$KINDNAME"
    echo "$KINDNAME:codingclass" | chpasswd

    # Desktop-Verzeichnis vorbereiten
    mkdir -p /home/$KINDNAME/Desktop
    mkdir -p /home/$KINDNAME/Projekte
    chown -R $KINDNAME:$KINDNAME /home/$KINDNAME

    # Variable für spätere Scripts speichern
    echo "KINDNAME=$KINDNAME" > /etc/coding-class.conf
    echo "User $KINDNAME erfolgreich erstellt"

  # ---------------------------------------------
  # GDM3 konfigurieren (Wayland deaktivieren + Auto-Login)
  # ---------------------------------------------
  - |
    source /etc/coding-class.conf
    GDM_CONF="/etc/gdm3/custom.conf"

    # Backup erstellen
    cp "$GDM_CONF" "$GDM_CONF.bak" 2>/dev/null || true

    # Komplette GDM3-Config neu schreiben
    cat > "$GDM_CONF" << EOF
    [daemon]
    WaylandEnable=false
    AutomaticLoginEnable=true
    AutomaticLogin=$KINDNAME

    [security]

    [xdmcp]

    [chooser]

    [debug]
    EOF

    echo "GDM3 konfiguriert: Wayland=off, AutoLogin=$KINDNAME"

  # ---------------------------------------------
  # x11vnc für Session-Sharing einrichten
  # ---------------------------------------------
  - |
    # VNC Passwort setzen
    mkdir -p /etc/x11vnc
    x11vnc -storepasswd levin /etc/x11vnc/passwd

    # Systemd Service für x11vnc
    cat > /etc/systemd/system/x11vnc.service << 'EOF'
[Unit]
Description=x11vnc Session Sharing
After=display-manager.service
Requires=display-manager.service

[Service]
Type=simple
ExecStartPre=/bin/sleep 10
ExecStart=/usr/bin/x11vnc -display :0 -auth guess -forever -loop -noxdamage -repeat -rfbauth /etc/x11vnc/passwd -rfbport 5900 -shared -capslock -nomodtweak
Restart=on-failure
RestartSec=5

[Install]
WantedBy=graphical.target
EOF

    systemctl daemon-reload
    systemctl enable x11vnc.service
    echo "x11vnc Service erstellt und aktiviert"

  # ---------------------------------------------
  # xrdp konfigurieren (verbindet zu VNC Session)
  # ---------------------------------------------
  - |
    cat > /etc/xrdp/xrdp.ini << 'EOF'
[Globals]
ini_version=1
fork=true
port=3389
tcp_nodelay=true
tcp_keepalive=true
security_layer=negotiate
crypt_level=high
certificate=
key_file=
ssl_protocols=TLSv1.2, TLSv1.3
autorun=Vnc-any
allow_channels=true
allow_multimon=true
bitmap_cache=true
bitmap_compression=true
bulk_compression=true
max_bpp=32
new_cursors=true
use_fastpath=both

[Logging]
LogFile=xrdp.log
LogLevel=INFO
EnableSyslog=true
SyslogLevel=INFO

[Channels]
rdpdr=true
rdpsnd=true
drdynvc=true
cliprdr=true
rail=true
xrdpvr=true
tcutils=true

[Vnc-any]
name=VNC Session
lib=libvnc.so
ip=127.0.0.1
port=5900
username=na
password=ask
EOF

    # SSL-Cert Zugriff
    adduser xrdp ssl-cert 2>/dev/null || true

    systemctl enable xrdp
    systemctl restart xrdp
    echo "xrdp konfiguriert"

  # ---------------------------------------------
  # Polkit für Farb-Management (Ubuntu 24.04 Style)
  # ---------------------------------------------
  - |
    # Ubuntu 24.04 nutzt JavaScript-basierte polkit Regeln
    mkdir -p /etc/polkit-1/rules.d
    cat > /etc/polkit-1/rules.d/45-allow-colord.rules << 'EOF'
polkit.addRule(function(action, subject) {
    if ((action.id == "org.freedesktop.color-manager.create-device" ||
         action.id == "org.freedesktop.color-manager.create-profile" ||
         action.id == "org.freedesktop.color-manager.delete-device" ||
         action.id == "org.freedesktop.color-manager.delete-profile" ||
         action.id == "org.freedesktop.color-manager.modify-device" ||
         action.id == "org.freedesktop.color-manager.modify-profile") &&
        subject.isInGroup("users")) {
        return polkit.Result.YES;
    }
});
EOF
    echo "Polkit Regeln erstellt"

  # ---------------------------------------------
  # Firewall
  # ---------------------------------------------
  - ufw allow 22/tcp
  - ufw allow 3389/tcp
  - ufw allow 5900/tcp
  - ufw --force enable

  # ---------------------------------------------
  # Desktop-Setup Service (statt rc.local)
  # Läuft nach dem ersten Boot
  # ---------------------------------------------
  - |
    cat > /etc/systemd/system/coding-class-setup.service << 'EOF'
[Unit]
Description=Coding Class Desktop Setup
After=snapd.seeded.service graphical.target
Wants=snapd.seeded.service

[Service]
Type=oneshot
ExecStart=/usr/local/bin/coding-class-setup.sh
RemainAfterExit=yes

[Install]
WantedBy=multi-user.target
EOF

    cat > /usr/local/bin/coding-class-setup.sh << 'SCRIPT'
#!/bin/bash
source /etc/coding-class.conf

echo "=== Coding Class Setup startet ==="

# Warten bis Snap fertig ist
for i in {1..30}; do
    if snap list code &>/dev/null; then
        echo "VS Code Snap gefunden"
        break
    fi
    echo "Warte auf Snap... ($i/30)"
    sleep 10
done

# Desktop-Verknüpfungen erstellen
DESKTOP_DIR="/home/$KINDNAME/Desktop"
mkdir -p "$DESKTOP_DIR"

# VS Code
if [ -f /var/lib/snapd/desktop/applications/code_code.desktop ]; then
    cp /var/lib/snapd/desktop/applications/code_code.desktop "$DESKTOP_DIR/"
    echo "VS Code Desktop-Link erstellt"
fi

# Firefox
if [ -f /usr/share/applications/firefox.desktop ]; then
    cp /usr/share/applications/firefox.desktop "$DESKTOP_DIR/"
    echo "Firefox Desktop-Link erstellt"
fi

# Ausführbar machen und Ownership setzen
chmod +x "$DESKTOP_DIR"/*.desktop 2>/dev/null || true
chown -R $KINDNAME:$KINDNAME "$DESKTOP_DIR"

# Service deaktivieren (einmalige Ausführung)
systemctl disable coding-class-setup.service

echo "=== Coding Class Setup abgeschlossen ==="
SCRIPT

    chmod +x /usr/local/bin/coding-class-setup.sh
    systemctl daemon-reload
    systemctl enable coding-class-setup.service
    echo "Desktop-Setup Service erstellt"

  # ---------------------------------------------
  # Abschluss-Marker erstellen
  # ---------------------------------------------
  - |
    echo "$(date): Cloud-init abgeschlossen" > /var/log/coding-class-complete.log
    echo "Hostname: $(hostname)" >> /var/log/coding-class-complete.log
    source /etc/coding-class.conf
    echo "Kind-User: $KINDNAME" >> /var/log/coding-class-complete.log

  # ---------------------------------------------
  # Reboot für sauberen Start
  # ---------------------------------------------
  - reboot

final_message: |
  =============================================
  Coding Class Desktop - Cloud-init fertig!
  Abgeschlossen nach $UPTIME Sekunden.
  Server startet jetzt neu...
  =============================================
