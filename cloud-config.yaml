#cloud-config
# =============================================================================
# Coding Class - Debian XFCE Desktop für Kinder
# =============================================================================
#
# VERWENDUNG:
#   1. Hetzner Cloud Console → Server erstellen
#   2. Server-Name: coding-class-<kindname> (z.B. "coding-class-friedrich")
#   3. Debian 12 auswählen
#   4. Bei "Cloud config" dieses YAML einfügen (KEINE Anpassung nötig!)
#   5. Server erstellen & warten (~5-10 Minuten)
#
# ZUGANG:
#   Kind (RDP):  <ip>:3389, User: <kindname>, Passwort: codingclass
#   Admin (VNC): vnc://<ip>:5900, Passwort: codingclass (screen sharing)
#   Admin (SSH): ssh levin@<ip>
#
# =============================================================================

# --- Admin-User ---
users:
  - name: levin
    groups: sudo, adm
    shell: /bin/bash
    sudo: ALL=(ALL) NOPASSWD:ALL
    lock_passwd: false
    plain_text_passwd: levin
    ssh_authorized_keys:
      - ecdsa-sha2-nistp256 AAAAE2VjZHNhLXNoYTItbmlzdHAyNTYAAAAIbmlzdHAyNTYAAABBBINCAQL3itd2FpbGK6xAka3mU/PzfZeKW8s6wRCmL5ONkUjffZC1BWG/iNi3XU4WX//piOemqmRzgYIjJW0gItY=
      - ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABgQCgXjznNCRu7IYiAq36fXravwWwwJ5xjCKgQo6pso48UMh2UJnjV2JjmFswUGKOD/zowUXveCwzRdh8jEvRBXoBJndbhaMC2Imu/5iWM2699VnkFEV3FbnKfHTIzJU+hiWr84pZobiHkc0jHO/HEzlGVzvVyegioxmz56a6BjalCeGhR/IHsObLQpVjWqetw+XSMzAj0dqTc+xg+bIMrnoSUDkroDrOarhdnsFPpu4NYPEiYqevbYEub0YNtEC9Zq/0gYBE73taBio4Fskb/NxQGzCjr0MNv63svXiUsDOtXdxdPRUmnsIvb0QXTKDct1zbw3y4qQdQUpVci1+z8uAC3oxBdA1JL4++KitYJfASzxnNWfVDl1hunfT72sbNxfHuZ1xMHoFkouFaeCwj8L2w4Wn5uxpq6sN+Qz/rOnzi+Tge8/sLY0NbU8+K7pW2EvcSdIWMzhbr8CWURCAZlqipJfPDJ+NZHOSdcQabJYLaOkuSDsxG0CWa1EuiplKb8TM=
      - ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIMYj2UzvHmgdiXlpwKuMzvv5CArJINWyrzmPHUSns17c claude-debug

# --- Pakete ---
package_update: true
package_upgrade: true

packages:
  # XFCE Desktop
  - xfce4
  - xfce4-goodies
  - xfce4-terminal
  - thunar
  - mousepad
  # X Server (wichtig für xrdp!)
  - xorg
  - xserver-xorg-core
  - xorgxrdp
  # Remote Desktop
  - xrdp
  - x11vnc
  # Browser & Apps (echte .deb, kein Snap!)
  - firefox-esr
  - firefox-esr-l10n-de
  # Entwicklungstools
  - git
  - build-essential
  - python3
  - python3-pip
  # System
  - htop
  - curl
  - wget
  - net-tools
  - dbus-x11
  - locales
  - locales-all
  - console-setup
  - ufw

# --- Konfigurationsdateien ---
write_files:
  # xRDP Startskript - startet XFCE + x11vnc für Screen Sharing
  - path: /etc/xrdp/startwm.sh
    permissions: '0755'
    content: |
      #!/bin/sh
      # xrdp X session start script - XFCE mit x11vnc Screen Sharing

      if test -r /etc/profile; then
          . /etc/profile
      fi

      # x11vnc für diese RDP-Session starten (Screen Sharing für Levin)
      if [ "$USER" != "levin" ] && [ -f /etc/x11vnc/passwd ]; then
          x11vnc -display $DISPLAY -forever -shared -rfbauth /etc/x11vnc/passwd -rfbport 5900 -bg -o /tmp/x11vnc-$USER.log 2>&1
      fi

      # XFCE starten
      exec startxfce4

  # xrdp.ini - optimiert für Performance
  - path: /etc/xrdp/xrdp.ini
    content: |
      [Globals]
      ini_version=1
      fork=true
      port=3389
      tcp_nodelay=true
      tcp_keepalive=true
      security_layer=negotiate
      crypt_level=low
      certificate=
      key_file=
      ssl_protocols=TLSv1.2, TLSv1.3
      autorun=
      allow_channels=true
      allow_multimon=true
      bitmap_cache=true
      bitmap_compression=true
      bulk_compression=true
      max_bpp=16
      new_cursors=true
      use_fastpath=both

      [Logging]
      LogFile=xrdp.log
      LogLevel=ERROR

      [Channels]
      rdpdr=true
      rdpsnd=false
      drdynvc=true
      cliprdr=true
      rail=false
      xrdpvr=false
      tcutils=true

      [Xorg]
      name=Xorg
      lib=libxup.so
      username=ask
      password=ask
      ip=127.0.0.1
      port=-1
      code=20

  # XFCE Performance-Einstellungen (kein Compositor)
  - path: /etc/skel/.config/xfce4/xfconf/xfce-perchannel-xml/xfwm4.xml
    content: |
      <?xml version="1.0" encoding="UTF-8"?>
      <channel name="xfwm4" version="1.0">
        <property name="general" type="empty">
          <property name="use_compositing" type="bool" value="false"/>
          <property name="box_move" type="bool" value="true"/>
          <property name="box_resize" type="bool" value="true"/>
        </property>
      </channel>

  # Autostart: Desktop-Icons als vertrauenswürdig markieren
  - path: /etc/xdg/autostart/trust-desktop-icons.desktop
    content: |
      [Desktop Entry]
      Type=Application
      Name=Trust Desktop Icons
      Exec=/usr/local/bin/trust-desktop-icons.sh
      Hidden=false
      NoDisplay=true

  - path: /usr/local/bin/trust-desktop-icons.sh
    permissions: '0755'
    content: |
      #!/bin/bash
      sleep 2
      for f in ~/Desktop/*.desktop; do
        if [ -f "$f" ]; then
          gio set "$f" metadata::trusted true 2>/dev/null
        fi
      done

  # Desktop-Setup Skript
  - path: /usr/local/bin/coding-class-setup.sh
    permissions: '0755'
    content: |
      #!/bin/bash
      source /etc/coding-class.conf

      echo "=== Coding Class Setup ==="

      for user in $KINDNAME levin; do
        DESKTOP_DIR="/home/$user/Desktop"
        mkdir -p "$DESKTOP_DIR"

        # VS Code
        [ -f /usr/share/applications/code.desktop ] && cp /usr/share/applications/code.desktop "$DESKTOP_DIR/"

        # Firefox
        [ -f /usr/share/applications/firefox-esr.desktop ] && cp /usr/share/applications/firefox-esr.desktop "$DESKTOP_DIR/"

        # Terminal
        [ -f /usr/share/applications/xfce4-terminal.desktop ] && cp /usr/share/applications/xfce4-terminal.desktop "$DESKTOP_DIR/"

        # File Manager
        [ -f /usr/share/applications/thunar.desktop ] && cp /usr/share/applications/thunar.desktop "$DESKTOP_DIR/"

        chmod +x "$DESKTOP_DIR"/*.desktop 2>/dev/null
        chown -R $user:$user "$DESKTOP_DIR"
      done

      echo "=== Setup done ==="

  # Default Browser setzen
  - path: /usr/share/applications/defaults.list
    content: |
      [Default Applications]
      x-scheme-handler/http=firefox-esr.desktop
      x-scheme-handler/https=firefox-esr.desktop
      text/html=firefox-esr.desktop

# --- Befehle ---
runcmd:
  # Hostname von Hetzner holen
  - |
    HETZNER_HOSTNAME=$(curl -sf --connect-timeout 2 http://169.254.169.254/hetzner/v1/metadata/hostname || echo "")
    if [ -n "$HETZNER_HOSTNAME" ]; then
      hostnamectl set-hostname "$HETZNER_HOSTNAME"
    fi

  # Kind-User aus Hostname erstellen
  - |
    KINDNAME=$(hostname | sed 's/^coding-class-//')
    echo "=== Erstelle User: $KINDNAME ==="
    useradd -m -s /bin/bash -G users "$KINDNAME"
    echo "$KINDNAME:codingclass" | chpasswd
    mkdir -p /home/$KINDNAME/Desktop /home/$KINDNAME/Projekte
    chown -R $KINDNAME:$KINDNAME /home/$KINDNAME
    echo "KINDNAME=$KINDNAME" > /etc/coding-class.conf

  # Locale und Tastatur auf Deutsch
  - sed -i 's/# de_DE.UTF-8 UTF-8/de_DE.UTF-8 UTF-8/' /etc/locale.gen
  - locale-gen
  - update-locale LANG=de_DE.UTF-8 LANGUAGE=de_DE:de
  - timedatectl set-timezone Europe/Berlin
  - |
    cat > /etc/default/keyboard << EOF
    XKBMODEL="pc105"
    XKBLAYOUT="de"
    XKBVARIANT=""
    XKBOPTIONS=""
    BACKSPACE="guess"
    EOF

  # VNC Passwort (muss lesbar sein für User-Session!)
  - mkdir -p /etc/x11vnc
  - x11vnc -storepasswd codingclass /etc/x11vnc/passwd
  - chmod 644 /etc/x11vnc/passwd

  # VS Code installieren (.deb)
  - |
    curl -fsSL https://packages.microsoft.com/keys/microsoft.asc | gpg --dearmor -o /usr/share/keyrings/microsoft.gpg
    echo "deb [arch=amd64 signed-by=/usr/share/keyrings/microsoft.gpg] https://packages.microsoft.com/repos/code stable main" > /etc/apt/sources.list.d/vscode.list
    apt-get update -qq
    apt-get install -y code

  # Swap (2GB)
  - fallocate -l 2G /swapfile
  - chmod 600 /swapfile
  - mkswap /swapfile
  - swapon /swapfile
  - echo "/swapfile none swap sw 0 0" >> /etc/fstab

  # XFCE Config für User
  - |
    source /etc/coding-class.conf
    for user in $KINDNAME levin; do
      mkdir -p /home/$user/.config/xfce4/xfconf/xfce-perchannel-xml
      cp /etc/skel/.config/xfce4/xfconf/xfce-perchannel-xml/xfwm4.xml /home/$user/.config/xfce4/xfconf/xfce-perchannel-xml/
      chown -R $user:$user /home/$user/.config
    done

  # xRDP konfigurieren
  - adduser xrdp ssl-cert 2>/dev/null || true
  - systemctl enable xrdp
  - systemctl start xrdp

  # Desktop-Verknüpfungen
  - /usr/local/bin/coding-class-setup.sh

  # Firewall
  - ufw allow 22/tcp
  - ufw allow 3389/tcp
  - ufw allow 5900/tcp
  - ufw --force enable

  # Abschluss
  - |
    source /etc/coding-class.conf
    echo "$(date): Cloud-init done, User: $KINDNAME, Desktop: Debian XFCE" > /var/log/coding-class-complete.log

  - reboot

final_message: "Coding Class Debian XFCE Desktop fertig nach $UPTIME Sekunden."
