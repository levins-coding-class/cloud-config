#cloud-config
# =============================================================================
# Coding Class - Debian XFCE Desktop für Kinder
# =============================================================================
#
# VERWENDUNG:
#   1. Hetzner Cloud Console → Server erstellen
#   2. Server-Name: coding-class-<kindname> (z.B. "coding-class-test-kind")
#   3. Debian 12 auswählen
#   4. Bei "Cloud config" dieses YAML einfügen (KEINE Anpassung nötig!)
#   5. Server erstellen & warten (~5-10 Minuten)
#
# ZUGANG:
#   Kind (RDP):  <ip>:3389, User: <kindname>, Passwort: <mentee_password>
#   Admin (VNC): vnc://<ip>:5900, Passwort: <vnc_password> (screen sharing)
#   Admin (SSH): ssh {{ADMIN_NAME}}@<ip>
#
# =============================================================================

# --- Admin-User ---
users:
  - name: {{ADMIN_NAME}}
    groups: sudo, adm
    shell: /bin/bash
    sudo: ALL=(ALL) NOPASSWD:ALL
    lock_passwd: false
    plain_text_passwd: {{ADMIN_PASSWORD}}
    ssh_authorized_keys:
{{SSH_AUTHORIZED_KEYS}}

# --- SSH-Sicherheit: Passwort-Login per SSH deaktivieren ---
# Nur SSH-Key-Authentifizierung erlauben (RDP/VNC nutzen weiterhin Passwörter)
ssh_pwauth: false

# --- Lokalisierung (nativ statt runcmd) ---
locale: de_DE.UTF-8
timezone: Europe/Berlin
keyboard:
  layout: de
  model: pc105

# --- Swap (nativ statt runcmd) ---
swap:
  filename: /swapfile
  size: 2147483648  # 2GB in Bytes
  maxsize: 2147483648

# --- Pakete ---
# =============================================================================
# WICHTIG: xrdp und VS Code werden NICHT hier, sondern in runcmd installiert!
# =============================================================================
#
# GRUND 1 - xrdp (dpkg-Konflikt):
#   cloud-init führt write_files VOR packages aus. Wenn wir startwm.sh und
#   xrdp.ini in write_files schreiben und dann xrdp via packages installieren,
#   fragt dpkg interaktiv: "Config-Datei existiert bereits, überschreiben?"
#   Da cloud-init nicht interaktiv ist, schlägt die Installation fehl.
#   LÖSUNG: xrdp in runcmd installieren, DANACH unsere Config schreiben.
#
# GRUND 2 - VS Code (GPG-Key-Problem):
#   Die cloud-init apt.sources Direktive mit keyid/key funktioniert auf
#   Debian 12 nicht zuverlässig - der GPG-Key wird nicht korrekt nach
#   /etc/apt/trusted.gpg.d/ importiert. apt-get update schlägt dann fehl
#   mit "NO_PUBKEY", und ALLE Pakete werden nicht installiert.
#   LÖSUNG: GPG-Key manuell in runcmd importieren, dann VS Code installieren.
#
# NICHT ÄNDERN: Diese Architektur wurde getestet und funktioniert.
# =============================================================================
package_update: true
package_upgrade: true

packages:
  # XFCE Desktop
  - xfce4
  - xfce4-goodies
  - xfce4-terminal
  - thunar
  - mousepad
  # X Server (wichtig für xrdp!)
  - xorg
  - xserver-xorg-core
  - xorgxrdp
  # x11vnc hier (hat keine Config-Konflikte)
  # xrdp wird in runcmd installiert - siehe Kommentar oben!
  - x11vnc
  # Browser & Apps (echte .deb, kein Snap!)
  - firefox-esr
  - firefox-esr-l10n-de
  # Entwicklungstools
  - git
  - build-essential
  - python3
  - python3-pip
  # System
  - htop
  - curl
  - wget
  - net-tools
  - dbus-x11
  - ufw
  - console-setup

# --- Konfigurationsdateien ---
# =============================================================================
# WICHTIG: xrdp-Dateien (startwm.sh, xrdp.ini) gehören NICHT hierher!
# =============================================================================
# write_files wird VOR packages ausgeführt. Wenn wir xrdp-Config hier
# schreiben, existieren die Dateien bereits wenn xrdp installiert wird.
# dpkg fragt dann interaktiv nach → Installation schlägt fehl.
# Die xrdp-Config wird stattdessen in runcmd geschrieben (siehe unten).
# =============================================================================
write_files:
  # XFCE Performance-Einstellungen (kein Compositor)
  - path: /etc/skel/.config/xfce4/xfconf/xfce-perchannel-xml/xfwm4.xml
    content: |
      <?xml version="1.0" encoding="UTF-8"?>
      <channel name="xfwm4" version="1.0">
        <property name="general" type="empty">
          <property name="use_compositing" type="bool" value="false"/>
          <property name="box_move" type="bool" value="true"/>
          <property name="box_resize" type="bool" value="true"/>
        </property>
      </channel>

  # Autostart: Desktop-Icons als vertrauenswürdig markieren
  - path: /etc/xdg/autostart/trust-desktop-icons.desktop
    content: |
      [Desktop Entry]
      Type=Application
      Name=Trust Desktop Icons
      Exec=/usr/local/bin/trust-desktop-icons.sh
      Hidden=false
      NoDisplay=true

  - path: /usr/local/bin/trust-desktop-icons.sh
    permissions: '0755'
    content: |
      #!/bin/bash
      sleep 2
      for f in ~/Desktop/*.desktop; do
        if [ -f "$f" ]; then
          gio set "$f" metadata::trusted true 2>/dev/null
        fi
      done

  # Desktop-Setup Skript
  - path: /usr/local/bin/coding-class-setup.sh
    permissions: '0755'
    content: |
      #!/bin/bash
      source /etc/coding-class.conf

      echo "=== Coding Class Setup ==="

      for user in $KINDNAME {{ADMIN_NAME}}; do
        DESKTOP_DIR="/home/$user/Desktop"
        mkdir -p "$DESKTOP_DIR"

        # VS Code
        [ -f /usr/share/applications/code.desktop ] && cp /usr/share/applications/code.desktop "$DESKTOP_DIR/"

        # Firefox
        [ -f /usr/share/applications/firefox-esr.desktop ] && cp /usr/share/applications/firefox-esr.desktop "$DESKTOP_DIR/"

        # Terminal
        [ -f /usr/share/applications/xfce4-terminal.desktop ] && cp /usr/share/applications/xfce4-terminal.desktop "$DESKTOP_DIR/"

        # File Manager
        [ -f /usr/share/applications/thunar.desktop ] && cp /usr/share/applications/thunar.desktop "$DESKTOP_DIR/"

        chmod +x "$DESKTOP_DIR"/*.desktop 2>/dev/null
        chown -R $user:$user "$DESKTOP_DIR"
      done

      echo "=== Setup done ==="

  # Default Browser setzen
  - path: /usr/share/applications/defaults.list
    content: |
      [Default Applications]
      x-scheme-handler/http=firefox-esr.desktop
      x-scheme-handler/https=firefox-esr.desktop
      text/html=firefox-esr.desktop

# --- Befehle (nur was nicht nativ geht) ---
runcmd:
  # Kind-User aus Hostname erstellen
  # (Hostname wird automatisch von Hetzner cloud-init datasource gesetzt)
  - |
    KINDNAME=$(hostname | sed 's/^coding-class-//')
    echo "=== Erstelle User: $KINDNAME ==="
    useradd -m -s /bin/bash -G users "$KINDNAME"
    echo "$KINDNAME:{{MENTEE_PASSWORD}}" | chpasswd
    mkdir -p /home/$KINDNAME/Desktop /home/$KINDNAME/Projekte
    chown -R $KINDNAME:$KINDNAME /home/$KINDNAME
    echo "KINDNAME=$KINDNAME" > /etc/coding-class.conf

  # VNC Passwort (muss lesbar sein für User-Session)
  - mkdir -p /etc/x11vnc
  - x11vnc -storepasswd {{VNC_PASSWORD}} /etc/x11vnc/passwd
  - chmod 644 /etc/x11vnc/passwd

  # =========================================================================
  # xrdp Installation und Config - MUSS in runcmd passieren!
  # =========================================================================
  # WARUM HIER UND NICHT IN packages?
  # 1. xrdp in packages installieren würde VOR runcmd passieren
  # 2. Aber wir brauchen custom startwm.sh und xrdp.ini
  # 3. write_files läuft VOR packages → Dateien existieren schon
  # 4. dpkg fragt interaktiv "Datei überschreiben?" → FEHLER
  # 5. LÖSUNG: xrdp hier installieren, DANN Config überschreiben
  # =========================================================================
  - DEBIAN_FRONTEND=noninteractive apt-get install -y xrdp

  # xrdp Config schreiben (jetzt existiert /etc/xrdp/ bereits)
  - |
    cat > /etc/xrdp/startwm.sh << 'STARTWM_EOF'
    #!/bin/sh
    # xrdp X session start script - XFCE mit x11vnc Screen Sharing

    if test -r /etc/profile; then
        . /etc/profile
    fi

    # x11vnc für diese RDP-Session starten (Screen Sharing für Admin)
    if [ "$USER" != "{{ADMIN_NAME}}" ] && [ -f /etc/x11vnc/passwd ]; then
        x11vnc -display $DISPLAY -forever -shared -rfbauth /etc/x11vnc/passwd -rfbport 5900 -bg -o /tmp/x11vnc-$USER.log 2>&1
    fi

    # XFCE starten
    exec startxfce4
    STARTWM_EOF
    chmod 755 /etc/xrdp/startwm.sh

  - |
    cat > /etc/xrdp/xrdp.ini << 'XRDPINI_EOF'
    [Globals]
    ini_version=1
    fork=true
    port=3389
    tcp_nodelay=true
    tcp_keepalive=true
    security_layer=negotiate
    crypt_level=low
    certificate=
    key_file=
    ssl_protocols=TLSv1.2, TLSv1.3
    autorun=
    allow_channels=true
    allow_multimon=true
    bitmap_cache=true
    bitmap_compression=true
    bulk_compression=true
    max_bpp=16
    new_cursors=true
    use_fastpath=both

    [Logging]
    LogFile=xrdp.log
    LogLevel=ERROR

    [Channels]
    rdpdr=true
    rdpsnd=false
    drdynvc=true
    cliprdr=true
    rail=false
    xrdpvr=false
    tcutils=true

    [Xorg]
    name=Xorg
    lib=libxup.so
    username=ask
    password=ask
    ip=127.0.0.1
    port=-1
    code=20
    XRDPINI_EOF

  # xRDP konfigurieren und starten
  - adduser xrdp ssl-cert 2>/dev/null || true
  - systemctl enable xrdp
  - systemctl restart xrdp

  # =========================================================================
  # VS Code Installation - MUSS in runcmd passieren!
  # =========================================================================
  # WARUM HIER UND NICHT IN packages MIT apt.sources?
  # 1. cloud-init apt.sources mit keyid/key ist auf Debian 12 buggy
  # 2. Der GPG-Key wird nicht korrekt importiert
  # 3. apt-get update schlägt fehl mit "NO_PUBKEY EB3E94ADBE1229CF"
  # 4. Dadurch werden ALLE Pakete nicht installiert (nicht nur VS Code!)
  # 5. LÖSUNG: GPG-Key manuell importieren, dann VS Code installieren
  # =========================================================================
  - |
    curl -fsSL https://packages.microsoft.com/keys/microsoft.asc | gpg --dearmor -o /etc/apt/trusted.gpg.d/microsoft.gpg
    echo "deb [arch=amd64 signed-by=/etc/apt/trusted.gpg.d/microsoft.gpg] https://packages.microsoft.com/repos/code stable main" > /etc/apt/sources.list.d/vscode.list
    apt-get update
    DEBIAN_FRONTEND=noninteractive apt-get install -y code

  # XFCE Config für User kopieren
  - |
    source /etc/coding-class.conf
    for user in $KINDNAME {{ADMIN_NAME}}; do
      mkdir -p /home/$user/.config/xfce4/xfconf/xfce-perchannel-xml
      cp /etc/skel/.config/xfce4/xfconf/xfce-perchannel-xml/xfwm4.xml /home/$user/.config/xfce4/xfconf/xfce-perchannel-xml/
      chown -R $user:$user /home/$user/.config
    done

  # Desktop-Verknüpfungen erstellen
  - /usr/local/bin/coding-class-setup.sh

  # Firewall konfigurieren
  - ufw allow 22/tcp
  - ufw allow 3389/tcp
  - ufw allow 5900/tcp
  - ufw --force enable

  # Abschluss loggen
  - |
    source /etc/coding-class.conf
    echo "$(date): Cloud-init done, User: $KINDNAME, Desktop: Debian XFCE" > /var/log/coding-class-complete.log

# --- Neustart nach Setup ---
power_state:
  mode: reboot
  message: "Cloud-init Setup abgeschlossen - Neustart..."
  timeout: 30
  condition: test -f /var/log/coding-class-complete.log

final_message: "Coding Class Debian XFCE Desktop fertig nach $UPTIME Sekunden."
