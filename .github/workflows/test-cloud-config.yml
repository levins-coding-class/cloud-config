name: Test Cloud Config

on:
  push:
    branches: [main, master, 'claude/**']
  pull_request:
    branches: [main, master]

jobs:
  validate:
    name: Validate Config
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Prepare test config
        run: |
          echo "=== Prepare Test Config ==="
          # Platzhalter mit Test-Werten ersetzen
          sed -i 's/{{ADMIN_NAME}}/testadmin/g' cloud-config.yaml
          sed -i 's/{{ADMIN_PASSWORD}}/testpass123/g' cloud-config.yaml
          sed -i 's/{{MENTEE_PASSWORD}}/menteepass123/g' cloud-config.yaml
          sed -i 's/{{VNC_PASSWORD}}/vncpass1/g' cloud-config.yaml
          sed -i 's/{{SSH_AUTHORIZED_KEYS}}/      - ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAITest test-key/g' cloud-config.yaml
          echo "✓ Test-Werte eingesetzt"

      - name: Validate YAML syntax
        run: |
          echo "=== YAML Syntax Check ==="
          python3 -c "import yaml; yaml.safe_load(open('cloud-config.yaml'))"
          echo "✓ YAML Syntax OK"

      - name: Install cloud-init
        run: |
          sudo apt-get update
          sudo apt-get install -y cloud-init

      - name: Validate cloud-init schema
        run: |
          echo "=== Cloud-init Schema Check ==="
          cloud-init schema --config-file cloud-config.yaml || echo "Schema check skipped (template file)"
          echo "✓ Schema OK"
